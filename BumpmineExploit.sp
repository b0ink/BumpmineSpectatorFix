#include <sourcemod>
#include <sdkhooks>
#include <sdktools>
#include <gadmin>
#include <multicolors>
#include <killcam>

#pragma newdecls required
#pragma semicolon 1


public Plugin myinfo =
{
	name = "Bumpmine Spectator Exploit Fix",
	author = "BOINK",
	description = "",
	version = "1.0.0",
	url = "https://oceservers.com"
};


public void OnPluginStart()
{

}

float g_bump_vec[3];
float DistanceToNearestBumpmine(int client){
	int iMaxEnts = GetMaxEntities();
	char sClassName[64];

	float client_vec[3];
	GetClientAbsOrigin(client, client_vec);
	float distanceToBeat = 999999.0;
	for(int i=MaxClients;i<iMaxEnts;i++){
		if(
		IsValidEntity(i) && 
		IsValidEdict(i) && 
		GetEdictClassname(i, sClassName, sizeof(sClassName)) &&
		StrContains(sClassName, "bumpmine", false) != -1
		){
			GetEntPropVector(i, Prop_Send, "m_vecOrigin", g_bump_vec);
			if(GetVectorDistance(client_vec, g_bump_vec) < distanceToBeat){
				distanceToBeat = GetVectorDistance(client_vec, g_bump_vec);
			}

		}
	}
	return distanceToBeat;
}



int GetClosestPlayer(int client){
	float dist = 999999.0;
	float client_vec[3];
	GetClientAbsOrigin(client, client_vec);
	int target = -1;
	float playerVec[3];
	for(int i = 0; i <= MaxClients; i++){
		if(IsValidClient(i) && IsPlayerAlive(i)){
			GetClientAbsOrigin(i, playerVec);
			if(GetVectorDistance(playerVec, client_vec) < dist){
				dist = GetVectorDistance(playerVec, client_vec);
				target = i;
			}
		}
	}
	return target;
}


public void OnGameFrame(){
	for(int i = 0; i <= MaxClients; i++){
		if(IsValidClient(i)){
			if(GetClientTeam(i) == CS_TEAM_SPECTATOR || !IsPlayerAlive(i)){
				if(!Client_InKillcam(i)){
					if(DistanceToNearestBumpmine(i) <= 200 && GetEntProp(i, Prop_Send, "m_iObserverMode") == 6){
						FakeClientCommand(i, "spec_player %N", GetClosestPlayer(i));
						CPrintToChat(i, "{lightblue}[{default}OS{lightblue}]{default} You can not go into freecam because you are too close to a bumpmine!");
					}
				}
			}
		}
	}
}

